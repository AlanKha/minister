<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Link Bank Account</title>
    <style>
      body {
        font-family: -apple-system, system-ui, sans-serif;
        max-width: 480px;
        margin: 60px auto;
        padding: 0 20px;
      }
      button {
        padding: 12px 24px;
        font-size: 16px;
        cursor: pointer;
        background: #635bff;
        color: #fff;
        border: none;
        border-radius: 6px;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      #status {
        margin-top: 24px;
        padding: 16px;
        border-radius: 6px;
        display: none;
      }
      #status.success {
        display: block;
        background: #e8f5e9;
        color: #2e7d32;
      }
      #status.error {
        display: block;
        background: #fce4ec;
        color: #c62828;
      }
    </style>
  </head>
  <body>
    <h1>Link Bank Account</h1>
    <button id="connect">Connect Bank Account</button>
    <div id="status"></div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
      const btn = document.getElementById("connect");
      const status = document.getElementById("status");

      function showStatus(msg, type) {
        status.textContent = msg;
        status.className = type;
      }

      btn.addEventListener("click", async () => {
        btn.disabled = true;

        try {
          const configRes = await fetch("/config");
          const { publishableKey } = await configRes.json();
          const stripe = Stripe(publishableKey);

          const sessionRes = await fetch("/create-session", { method: "POST" });
          const sessionData = await sessionRes.json();
          if (sessionData.error) throw new Error(sessionData.error);

          const result = await stripe.collectFinancialConnectionsAccounts({
            clientSecret: sessionData.clientSecret,
          });

          if (result.error) throw new Error(result.error.message);

          const accounts = result.financialConnectionsSession.accounts;

          for (const account of accounts) {
            const saveRes = await fetch("/save-account", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                accountId: account.id,
                institution: account.institution_name || null,
                displayName: account.display_name || null,
                last4: account.last4 || null,
              }),
            });
            const saveData = await saveRes.json();
            if (saveData.error) throw new Error(saveData.error);
          }

          const details = accounts
            .map((a) =>
              [
                a.institution_name,
                a.display_name,
                a.last4 ? `****${a.last4}` : null,
              ]
                .filter(Boolean)
                .join(" - "),
            )
            .join("\n");

          showStatus(
            `Linked ${accounts.length} account(s):\n${details}`,
            "success",
          );
        } catch (err) {
          showStatus(err.message, "error");
        } finally {
          btn.disabled = false;
        }
      });
    </script>
  </body>
</html>
